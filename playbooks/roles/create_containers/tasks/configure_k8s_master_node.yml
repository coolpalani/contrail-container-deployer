---
- name: initialize k8s master
  shell: | 
      kubeadm init --kubernetes-version v1.7.4 &&
      mkdir -p $HOME/.kube &&
      cp -u /etc/kubernetes/admin.conf $HOME/.kube/config &&
      chown -R $(id -u):$(id -g) $HOME/.kube
  when: inventory_hostname == master

- name: get master token
  shell: kubeadm token list |grep "The default bootstrap token generated by 'kubeadm init'." |awk '{print $1}'
  register: output
  when: inventory_hostname == master

- name: set master token
  set_fact:
    mastertoken: "{{ output.stdout }}"
  when: inventory_hostname == master

#- name: patch k8s master 1
#  shell: "kubectl patch deploy/kube-dns --type json  -p=\'[{\"op\": \"replace\", \"path\": \"/spec/template/spec/containers/0/readinessProbe\", \"value\": {\"exec\": {\"command\": [\"wget\", \"-O\", \"-\", \"http://127.0.0.1:8081/readiness\"]}}}]\' -n kube-system"
#  when: master == inventory_hostname
#
#- name: patch k8s master 2
#  shell: "kubectl patch deploy/kube-dns --type json  -p=\'[{\"op\": \"replace\", \"path\": \"/spec/template/spec/containers/0/livenessProbe\", \"value\": {\"exec\": {\"command\": [\"wget\", \"-O\", \"-\", \"http://127.0.0.1:10054/healthcheck/kubedns\"]}}}]\' -n kube-system && kubectl patch deploy/kube-dns --type json  -p=\'[{\"op\": \"replace\", \"path\": \"/spec/template/spec/containers/1/livenessProbe\", \"value\": {\"exec\": {\"command\": [\"wget\", \"-O\", \"-\", \"http://127.0.0.1:10054/healthcheck/dnsmasq\"]}}}]\' -n kube-system"
#  when: master == inventory_hostname
#
#- name: patch k8s master 3
#  shell: "kubectl patch deploy/kube-dns --type json  -p=\'[{\"op\": \"replace\", \"path\": \"/spec/template/spec/containers/2/livenessProbe\", \"value\": {\"exec\": {\"command\": [\"wget\", \"-O\", \"-\", \"http://127.0.0.1:10054/metrics\"]}}}]\' -n kube-system"
#  when: master == inventory_hostname
